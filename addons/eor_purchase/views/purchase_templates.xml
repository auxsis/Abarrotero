<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="assets_backend" inherit_id="web.assets_backend">
        <xpath expr="." position="inside">
            <link rel="stylesheet" href="/eor_purchase/static/src/css/purchase.css"/>

            <script src="/eor_purchase/static/src/js/purchase.js" type="text/javascript"></script>
        </xpath>
    </template>

    <!-- Align Company Address in header to left -->
    <template id="external_layout_clean_eor_purchase" inherit_id="web.external_layout_clean">
        <xpath expr="//div[@class='col-4'][1]" position="attributes">
            <attribute name="class">col-3</attribute>
        </xpath>
        <xpath expr="//div[@name='company_address']" position="attributes">
            <attribute name="class">col-5</attribute>
            <attribute name="style">text-align: left;</attribute>
        </xpath>
    </template>

    <!--Hide Destination Address in the Purchase Quotation. Just delete its content-->
    <template id="purchase_stock.report_purchasequotation_document" inherit_id="purchase.report_purchasequotation_document">
    </template>

    <!--Hide Partner Address in the Purchase Quotation-->
    <!-- Reduce padding in lines -->
    <template id="report_purchasequotation_eor_purchase" inherit_id="purchase.report_purchasequotation_document">

        <xpath expr="//t[@t-set='address']" position="replace">
        </xpath>
        <xpath expr="//table/tbody/tr" position="replace">
             <tr t-foreach="o.order_line" t-as="order_line">
                <td class="pt-1 pb-1">
                    <span t-field="order_line.name"/>
                </td>
                <!--
                <td class="text-center">
                    <span t-field="order_line.date_planned"/>
                </td>
                -->
                <td class="text-right pt-1 pb-1">
                    <span t-field="order_line.product_qty"/>
                </td>
                <td class="text-right pt-1 pb-1">
                    <span t-field="order_line.product_uom" groups="uom.group_uom"/>
                </td>
                <td class="text-right pt-1 pb-1">
                </td>
                <td class="text-right pt-1 pb-1">
                </td>
            </tr>
        </xpath>

        <!-- Add Articulos y Total Unidades to Purchas Quotation -->
        <xpath expr="//tbody" position="after">
            <thead>
                <tr>
                    <th><strong>Articulos :    <span t-esc="len(o.order_line)"/> </strong></th>
                    <th class="text-right"><strong>Total Unidades : <span t-esc="sum(o.order_line.mapped('product_qty'))"/></strong></th>
                </tr>
            </thead>
        </xpath>

        <!-- Add signatures section for Quotation -->
        <xpath expr="//p[@t-field='o.notes']" position="after">
            <div name="signatures" class="row" style="margin: 20px; margin-top: 80px; page-break-inside: avoid;">
              <div class="col-4 p-2 text-center" style="border-top: 2px solid;">RECIBIÓ EN ALMACÉN</div>
              <div class="col-4"></div>
              <div class="col-4 p-2 text-center" style="border-top: 2px solid;">SUPERVISOR(A) ALMACÉN</div>
            </div>
        </xpath>

        <!-- Remove info from footer in Quotation and Purchase Order -->
        <xpath expr="//div[@name='signatures']" position="after">
            <div class="footer" style="font-size:10px;">
                <div class="text-center" style="font-size:10px;">
                    <div t-if="report_type == 'pdf'" class="text-muted">
                        Page: <span class="page"/> / <span class="topage"/>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <!-- Reduce padding in lines for Purchase Orders -->
    <template id="report_purchaseorder_eor_purchase" inherit_id="purchase.report_purchaseorder_document">

        <!-- Change report title for Purchase Orders  -->
        <xpath expr="//h3[contains(@t-if, 'purchase')]" position="replace">
            <h3 t-if="o.state in ['purchase', 'done']">Orden de Compra #<span t-field="o.name"/></h3>
        </xpath>

        <xpath expr="//table/tbody/tr" position="replace">
            <tr t-foreach="o.order_line" t-as="line">
                <t t-set="number_arti" t-value="number_arti + 1"/>
                <td class="pt-1 pb-1">
                    <span t-field="line.name"/>
                </td>

                <!--
                <td class="text-center">
                    <span t-field="line.date_planned"/>
                </td>
                -->
                <td class="text-right pt-1 pb-1">
                    <span t-esc="'%.2f'%(line.product_qty)"/>
                </td>
                <td class="pt-1 pb-1">
                    <t t-set="number_box" t-value="number_box + line.product_qty"/>
                    <span t-field="line.product_uom.name" groups="uom.group_uom"/>
                </td>
                <td class="text-right pt-1 pb-1">
                    <span t-esc="'%.2f'%(line.price_unit)"/>
                </td>

                <td class="pt-1 pb-1">
                    <span t-esc="', '.join(map(lambda x: x.name, line.taxes_id))"/>
                </td>
                <!-- Precio unitario con Impuestos -->
                 <td class="text-right pt-1 pb-1">
                  <t t-set="price_unit" t-value="line.price_unit" />
                  <t t-set="qty" t-value="line.product_qty" />
                  <t t-set="tax" t-value="line.taxes_id.amount / 100" />
                  <t t-set="price_tax" t-value="price_unit + (price_unit * tax)" />
                  <span t-esc="'%.2f'%(price_tax)"/>

                </td>
                <td class="text-right pt-1 pb-1">
                    <span t-field="line.price_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                </td>
            </tr>
        </xpath>

        <!-- Reduce space (margin top) between order lines and total lines -->
        <xpath expr="//div[@id='total']" position="attributes">
            <attribute name="style">margin-top: -45px;</attribute>
        </xpath>

        <!-- Reduce padding in total lines for "Purchase Orders" -->
        <xpath expr="//div[@id='total']/div/table" position="replace">
            <table class="table table-sm">
                <tr class="border-black">
                    <td class="pt-1 pb-1"><strong>Subtotal</strong></td>
                    <td class="text-right pt-1 pb-1">
                        <span t-field="o.amount_untaxed" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                    </td>
                </tr>
                <tr>
                    <td class="pt-1 pb-1">Taxes</td>
                    <td class="text-right pt-1 pb-1">
                        <span t-field="o.amount_tax" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                    </td>
                </tr>
                <tr class="border-black o_total">
                    <td class="pt-1 pb-1"><strong>Total</strong></td>
                    <td class="text-right pt-1 pb-1">
                        <span t-field="o.amount_total" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                    </td>
                </tr>
            </table>

        </xpath>
    </template>


</odoo>